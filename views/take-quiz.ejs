<%- include('partials/header') %>
  <%- include('partials/navbar') %>

    <!-- Load Tailwind only if not already present (safe if header already includes it) -->
    <script>
      if (typeof window !== 'undefined' && typeof window.tailwind === 'undefined') {
        var s = document.createElement('script');
        s.src = "https://cdn.tailwindcss.com";
        document.head.appendChild(s);
      }
    </script>

    <main class="container mx-auto px-4 py-8 max-w-3xl">
      <% if (typeof quiz==='undefined' || !quiz) { %>
        <div class="bg-white p-6 rounded-2xl shadow-sm text-center">
          <p class="text-lg text-gray-700">Quiz not found.</p>
        </div>
        <% } else { %>
          <div class="bg-white p-6 rounded-2xl shadow-sm">
            <header class="mb-6">
              <h1 class="text-2xl font-extrabold">
                <%= quiz.title %>
              </h1>
              <p class="text-sm text-gray-500">By: <%= quiz.creatorName %>
              </p>
            </header>

            <div class="flex justify-end mb-4">
              <div id="timer-wrapper" class="w-20 h-20 relative" aria-hidden="false">
                <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100" role="img"
                  aria-label="Quiz timer">
                  <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="10" fill="none"></circle>
                  <circle id="timer-ring" cx="50" cy="50" r="45" stroke="#34d399" stroke-width="10"
                    stroke-linecap="round" fill="none" stroke-dasharray="282.743" stroke-dashoffset="0"></circle>
                </svg>
                <div id="timer-text"
                  class="absolute inset-0 flex items-center justify-center text-sm font-semibold text-gray-800">0:00
                </div>
              </div>
            </div>

            <form id="take-quiz-form" action="/quizzes/<%= quiz._id %>/submit" method="POST" class="space-y-6">
              <!-- Hidden fields -->
              <input type="hidden" id="quiz-id" name="quizId" value="<%= quiz._id %>" />
              <input type="hidden" id="answers-json" name="answers" />

              <!-- Question area -->
              <div id="question-area" class="space-y-4"></div>

              <!-- Navigation -->
              <div class="flex items-center justify-between gap-3 mt-4">
                <button type="button" id="prev-btn" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200"
                  disabled>← Previous</button>

                <div class="flex items-center gap-2">
                  <span id="progress" class="text-sm text-gray-600"></span>
                </div>

                <button type="button" id="next-btn"
                  class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Next →</button>
              </div>

              <!-- Submit (visible on last question) -->
              <div class="mt-4">
                <button id="submit-btn" type="submit"
                  class="w-full px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 hidden">
                  Submit Quiz
                </button>
              </div>
            </form>
          </div>
          <% } %>
    </main>

    <%- include('partials/footer') %>

      <script>
        (function () {
          // embed server-side quiz safely into client-side JS
          // use <%- %> (raw) to inject the JSON; JSON.stringify on server makes a valid JS object literal
          const quiz = <%- JSON.stringify(quiz || {}) %>;

          // sanity check
          if (!quiz || !Array.isArray(quiz.questions)) {
            console.warn('No quiz questions provided or questions is not an array', quiz);
            // optionally render "Quiz not found" UI or return
          }

          const questions = Array.isArray(quiz.questions) ? quiz.questions : [];
          let currentIndex = 0;
          const answers = new Array(questions.length).fill(null); // stores selected option index per question

          // timer setup moved below after DOM refs

          var questionArea = document.getElementById('question-area');
          var prevBtn = document.getElementById('prev-btn');
          var nextBtn = document.getElementById('next-btn');
          var submitBtn = document.getElementById('submit-btn');
          var progress = document.getElementById('progress');
          var answersJson = document.getElementById('answers-json');
          var form = document.getElementById('take-quiz-form');

          // Circular ring timer: uses `quiz.duration` in seconds (0 = no timer)
          (function setupCircularTimer() {
            const durationSeconds = Number(quiz.duration) && !Number.isNaN(Number(quiz.duration)) ? Number(quiz.duration) : 0;
            const timerWrapper = document.getElementById('timer-wrapper');
            const ring = document.getElementById('timer-ring');
            const timerText = document.getElementById('timer-text');
            if (!durationSeconds) {
              if (timerWrapper) timerWrapper.style.display = 'none';
              return;
            }

            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            if (ring) {
              ring.style.strokeDasharray = String(circumference);
              ring.style.transition = 'stroke-dashoffset 0.35s linear, stroke 0.35s linear';
            }

            let remaining = durationSeconds;
            function formatTime(s) {
              const m = Math.floor(s / 60);
              const ss = s % 60;
              return String(m) + ':' + String(ss).padStart(2, '0');
            }

            function setRingForRemaining(rem) {
              const fraction = Math.max(0, Math.min(1, rem / durationSeconds));
              const offset = circumference * (1 - fraction);
              if (ring) ring.style.strokeDashoffset = String(offset);
              // color thresholds: >50% green, >20% orange, else red
              if (ring) {
                if (fraction > 0.5) ring.setAttribute('stroke', '#34d399');
                else if (fraction > 0.2) ring.setAttribute('stroke', '#f59e0b');
                else ring.setAttribute('stroke', '#ef4444');
              }
            }

            // initial render
            if (timerText) timerText.textContent = formatTime(remaining);
            setRingForRemaining(remaining);

            const timerInterval = setInterval(function () {
              remaining = remaining - 1;
              if (timerText) timerText.textContent = formatTime(Math.max(0, remaining));
              setRingForRemaining(remaining);
              if (remaining <= 0) {
                clearInterval(timerInterval);
                // capture current selection
                try {
                  var sel = questionArea.querySelector('input[type="radio"]:checked');
                  if (sel) answers[currentIndex] = parseInt(sel.value, 10);
                  answersJson.value = JSON.stringify(answers);
                } catch (e) { /* ignore */ }
                try { nextBtn.disabled = true; prevBtn.disabled = true; submitBtn.disabled = true; } catch (e) { }
                form.submit();
              }
            }, 1000);
          })();

          // Basic HTML escaper
          function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function (m) {
              return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
              })[m];
            });
          }

          function renderQuestion(idx) {
            var q = questions[idx];
            if (!q) {
              questionArea.innerHTML = '<div class="p-4 border rounded-lg text-gray-600">Question unavailable.</div>';
              progress.textContent = '';
              prevBtn.disabled = true;
              nextBtn.classList.add('hidden');
              submitBtn.classList.add('hidden');
              return;
            }

            var html = '';
            html += '<div class="p-4 border rounded-lg">';
            html += '<div class="mb-3"><div class="text-sm text-gray-500">Question ' + (idx + 1) + ' of ' + questions.length + '</div></div>';
            html += '<div class="mb-4"><div class="font-medium text-gray-800 mb-2">' + escapeHtml(q.question) + '</div></div>';

            // options
            html += '<div class="space-y-2">';
            if (Array.isArray(q.options) && q.options.length) {
              q.options.forEach(function (opt, optIndex) {
                var checked = (answers[idx] === optIndex) ? 'checked' : '';
                // name is unique per question so only one selected per question
                html += '<label class="block bg-gray-50 px-3 py-2 rounded-lg cursor-pointer">';
                html += '<input type="radio" name="q_' + idx + '" value="' + optIndex + '" class="mr-3" ' + checked + ' />';
                html += '<span>' + escapeHtml(opt) + '</span>';
                html += '</label>';
              });
            } else {
              html += '<div class="text-sm text-gray-500">No options provided.</div>';
            }
            html += '</div>'; // options
            html += '</div>'; // wrapper

            questionArea.innerHTML = html;

            // update progress and navigation
            progress.textContent = 'Question ' + (idx + 1) + ' / ' + questions.length;
            prevBtn.disabled = idx === 0;

            if (idx === questions.length - 1) {
              nextBtn.classList.add('hidden');
              submitBtn.classList.remove('hidden');
            } else {
              nextBtn.classList.remove('hidden');
              submitBtn.classList.add('hidden');
            }

            // wire up change handlers for the radios to capture answers immediately
            var radios = questionArea.querySelectorAll('input[type="radio"]');
            radios.forEach(function (r) {
              r.addEventListener('change', function (ev) {
                answers[idx] = parseInt(ev.target.value, 10);
              });
            });
          }

          // navigation
          prevBtn.addEventListener('click', function () {
            // save current selection (if any)
            var sel = questionArea.querySelector('input[type="radio"]:checked');
            if (sel) answers[currentIndex] = parseInt(sel.value, 10);

            if (currentIndex > 0) {
              currentIndex--;
              renderQuestion(currentIndex);
            }
          });

          nextBtn.addEventListener('click', function () {
            // save current selection (if any)
            var sel = questionArea.querySelector('input[type="radio"]:checked');
            if (sel) answers[currentIndex] = parseInt(sel.value, 10);

            if (currentIndex < questions.length - 1) {
              currentIndex++;
              renderQuestion(currentIndex);
            }
          });

          // form submit: serialize answers into hidden input
          form.addEventListener('submit', function (e) {
            // capture current selection before submit
            var sel = questionArea.querySelector('input[type="radio"]:checked');
            if (sel) answers[currentIndex] = parseInt(sel.value, 10);

            // By default allow partial submissions (null for unanswered). If you want to require all answered, uncomment validation below.
            /*
            if (answers.includes(null)) {
              e.preventDefault();
              alert('Please answer all questions before submitting!');
              return;
            }
            */

            answersJson.value = JSON.stringify(answers);
            // form will submit normally
          });

          // initial render
          renderQuestion(0);
        })();
      </script>